---
title: "Exerc√≠cio Regress√£o Linear"
author: "Victor Alcantara"
date: "14/05/2021"
output:
  word_document: default
  pdf_document: default
---

# 0. Carregando pacotes e abrindo os dados 
# Dados sobre mercado de trabalho no Brasil: 1¬∫ trimestre/2019 da Pnad-cont√≠nua

```{r, warning = FALSE, message = FALSE}
library(PNADcIBGE) # Para importar dados da Pnad cont√≠nua
library(tidyverse) # Para organizar e analisar os dados
library(Hmisc)     # Para an√°lises com peso amostral
library(weights)   #
library(ggplot2)   # Para gr√°ficos
library(ggExtra)   # Para fun√ß√µes extra do ggplot
library(rio)       # R Imput Output
require(fst)       # FST √© requisito para o RIO salvar nesse formato
```

# 1. Selecionando vari√°veis e filtrando casos
# verbos select e filter

1. (V2009)  Idade do morador na data de refer√™ncia
2. (VD3005) Anos de estudo (pessoas de 5 anos ou mais de idade) padronizado para o Ensino fundamental com dura√ß√£o de 9 anos
3. (VD4016) Rendimento mensal habitual do trabalho principal para pessoas de 14 anos ou mais de idade (apenas para pessoas que receberam em dinheiro, produtos ou mercadorias no trabalho principal)
4. (V1027)  Peso do domic√≠lio e das pessoas (Peso trimestral com corre√ß√£o de n√£o entrevista com p√≥s estratifica√ß√£o pela proje√ß√£o de popula√ß√£o)

```{r, warning=FALSE}
wd <- ("C:/Users/Victor/estatistica/dados/PNAD/")

mydata <- import(paste0(wd, 2019, "/pnadc_", 2019,"-1q.fst")) %>% 
               
               select(V2009, VD3005,VD4016,V1027) %>% 
  
               rename(.,  idade        = V2009,
                          escolaridade = VD3005,
                          renda        = VD4016,
                          peso         = V1027) %>%

                filter(renda > 0,                
                       idade %in% 18:65)

```

# 2. Computando modifica√ß√µes necess√°rias
# verbos as.numeric, log(), ifelse

```{r}
mydata <- mydata %>% 
          mutate(., escolaridade = as.numeric(escolaridade),
                    ln.renda     = log(renda),
                    exp          = idade - escolaridade - 6, # exp de Mincer
                    exp          = ifelse(exp < 0, 0, exp) ) 
```

# 3. Colocando a m√£o na massa 
```{r}
# Antes de tudo, conferir o banco de dados
summary(mydata)

# Salvando o banco ap√≥s tratamento para a an√°lise
#setwd("C:/Users/Victor/estatistica/dados/PNAD/2019 trimestral/")

#write.csv(mydata, file = "mydata.csv", row.names = FALSE) # Op√ß√£o 1 para salvar o recorte da base de dados em formato CSV

#mydata <- read.csv("mydata.csv" ) # Abrindo o recorte

#save( mydata, file = paste0(wd, "mydata.RData" ) ) # Op√ß√£o 2 para salvar o recorte da base de dados em formato RDS

#load( paste0(wd, "mydata.RData" ) ) # Abrindo o recorte

dim(data)
dim(mydata) # Diminuiram os casos ap√≥s os filtros, e as var ap√≥s a sele√ß√£o

# m√©dia, primeiro quartil, segundo quartil (mediana), terceiro quartil, desvio-padr√£o e vari√¢ncia para idade, escolaridade, renda e logaritmo da renda

# Para computar uma fun√ß√£o com v√°rios objetos diferentes, podemos usar o loops para mecanizar a sequ√™ncia de comandos.

for(i in c("idade", "escolaridade", "renda", "ln.renda")) {
         media <- wtd.mean(x = mydata[i], weights = mydata$peso, na.rm = T)
    print(media)
     }

# Por√©m, como queremos mais de uma opera√ß√£o para diferentes objetos, vamos computar uma nova fun√ß√£o que fa√ßa todas as opera√ß√µes que precisamos para cada objeto.

my_stats <- function(data, x, y, na.rm) {
    media     <- wtd.mean(x = data[,x], weights = data[,y], na.rm = na.rm)
    variancia <- wtd.var (x = data[,x], weights = data[,y], na.rm = na.rm)
    quantis   <- wtd.quantile(x = data[,x], weights = data[,y], 
                 probs = c(0.25,0.5,0.75), na.rm = na.rm) 
    
    stats <- list(quantis = quantis, media = media, variancia = variancia,
                  dp = sqrt(variancia)) # Em lista por conta dos quantiles
    print(stats)
    rm(stats)
}

# Com essa fun√ß√£o podemos calcular todas as medidas de tend√™ncia central e de dispers√£o para cada objeto (vari√°vel). Note que o desvio-padr√£o √© dado pela raiz da vari√¢ncia, e por isso aparece computado dentro da lista.

```

# Escolaridade
```{r fig.align="center", warning = FALSE, message = FALSE}
options(scipen = 999) # Para excluir a nota√ß√£o cient√≠fica

my_stats(data = mydata, x = "escolaridade", y = "peso", na.rm = T)

mydata %>% ggplot(aes(x = escolaridade, weight = peso))+
      geom_bar()+
        theme_bw()+
        ggtitle("Anos de estudo")+
        scale_y_continuous(name = "Frequ√™ncia" )+
        scale_x_continuous(name = "Anos de estudo",
                           breaks = seq(from = 0, to = 17, by = 1))+
        labs(caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

Com o gr√°fico de barras acima podemos observar uma concentra√ß√£o de pessoas com 13 anos de estudo, o que corresponde ao Ensino M√©dio completo, uma parcela significativa com 17 anos de estudo, o que corresponde ao Ensino Superior completo, e grupos minorit√°rios com 6 e 10 anos de estudo, o que corresponde, respectivamente, ao Ensino Fundamental incompleto e completo. 

√â importante lembrar que estamos trabalhando com um recorte da amostra com pessoas com renda e idade entre 18-64 anos. Portanto, os anos de escolaridade representados no gr√°fico n√£o refletem os n√≠veis de escolaridade alcan√ßado pela popula√ß√£o.

# Idade
```{r fig.align="center", warning = FALSE, message = FALSE}
my_stats(data = mydata, x = "idade", y = "peso", na.rm = T)

mydata %>% ggplot(aes(x = idade, weight = peso))+
    geom_bar()+
        theme_bw()+
        ggtitle("Idade")+
        scale_y_continuous(name = "Frequ√™ncia")+
        scale_x_continuous(name = "Idade" ,
                           limits = c(18,65),
                           breaks = seq(18,64,2)
                           )+
        labs(caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

Com o gr√°fico de barras acima podemos observar uma concentra√ß√£o de pessoas entre 24 e 50 anos, o que corresponde √† uma parcela da popula√ß√£o em idade ativa, com uma tend√™ncia √† redu√ß√£o de pessoas com idade acima de 50 anos. Como a idade √© uma vari√°vel m√©trica cont√≠nua, podemos representar tamb√©m por um histograma com faixas et√°rias.

# Experi√™ncia
```{r}
my_stats(data = mydata, x = "exp" ,y = "peso", na.rm = T)

mydata %>% ggplot(aes(x = exp, weight = peso))+
    geom_bar()+
      theme_bw()+
      ggtitle("Experi√™ncia")+
      scale_y_continuous(name = "Frequ√™ncia")+
      scale_x_continuous(name = "Experi√™ncia",
                         breaks = seq(from = 0, to = 60, by = 5) )+
      labs(subtitle = "exp. = Idade - Anos de estudo - 6",
           caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

O gr√°fico de barras acima representa a frequ√™ncia de observa√ß√µes nos determinados anos de experi√™ncia, que foi calculado em fun√ß√£o da idade, dos anos de estudo e de uma constante 6. Compreende-se que a experi√™ncia √© igual a idade menos os anos de estudo e a constante 6. Indiv√≠duos com 18 anos de idade e 16 anos de estudo, por exemplo, teriam experi√™ncia menor que zero. Pela impossibilidade l√≥gica de uma pessoa ter menor que zero anos de experi√™ncia, computou-se todos os valores negativos como zero. J√° indiv√≠duos com 64 anos e 16 anos de estudo teriam 42 anos de experi√™ncia, enquanto que os com 0 anos de estudos teriam 58 anos de experi√™ncia. No limite, portanto, temos que a experi√™ncia pode variar de 0 - 58 anos em nosso recorte da amostra. Os casos com experi√™ncia at√© 35 anos s√£o mais frequentes, enquanto que h√° uma tend√™ncia de decrescimento da frequ√™ncia de casos com mais de 35 anos de experi√™ncia. Podemos inferir, por exemplo, que essa tend√™ncia acompanha o decrescimento da popula√ß√£o com idade superior √† 50 anos, como observamos no gr√°fico relativo √† idade.

# Renda
```{r fig.align="center", warning = FALSE, message = FALSE}
my_stats(data = mydata, x = "renda", y = "peso", na.rm = T)

mydata %>% ggplot(aes( x = renda, weight = peso)) +
    geom_histogram(binwidth = 5000)+
      theme_bw()+
      scale_y_continuous(name = "frequ√™ncia",
                         limits = c(0,50000),
                         breaks = seq(0,50000,10000))+
      scale_x_continuous(name = "renda",
                         limits = c(0,255000),
                         breaks = seq(0,255000,25000)
                         )+
      labs(title = "",
           caption = "")
```

O histograma acima representa a frequ√™ncia de casos com determinada renda, dada entre faixas agrupadas pelas barras. Podemos observar que h√° uma concenra√ß√£o de casos entre 2.500 e 5.000, com algumas observa√ß√µes distantes da concentra√ß√£o em aproximadamente 15, 17.5 e 25 mil.

```{r fig.align="center", warning = FALSE, message = FALSE}
my_stats(data = mydata, x = "ln.renda", y = "peso", na.rm = T)

mydata %>%
ggplot(aes( x = ln.renda, weight = peso)) +
geom_histogram()+
    theme_bw()+
    scale_y_continuous(name = "frequ√™ncia")+
    scale_x_continuous(name = "log da renda")+
    labs(title = "",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")

```

O histograma acima representa a frequ√™ncia de casos com o logar√≠tmo natural de determinada renda, ou em outras palavras a renda logaritmizada. Note que o log √© uma opera√ß√£o inversa da exponencial, e portanto comprime a dist√¢ncia entre os casos, ao inv√™s de atenuar. O log de 1000 na base 10, por exemplo, √© 3, ou em outras palavras, 10 elevado a 3 √© 1000.  Os casos com renda logaritmizada igual a 5 correspondem √† base do log natural (e = 2.71) elevada a 5, ou 143.48. Nessa mesma l√≥gica, os casos com log da renda em 10 corresponde √† 20.589.11. 
A transforma√ß√£o logar√≠tmica √© frequentemente usada para corrigir a assimetria de vari√°veis, como renda e popula√ß√£o, que t√™m um pequeno n√∫mero de observa√ß√µes com valores positivos extremamente grandes ou pequenos e muito distantes da concentra√ß√£o. Com a renda logaritmizada, as dist√¢ncias entre as observa√ßoes s√£o comprimidas, fazendo com que o enviesamento/assimetria (skewness) seja eliminado e a distribui√ß√£o seja mais pr√≥xima de uma distribui√ß√£o normal.

```{r fig.align="center", warning = FALSE, message = FALSE}
mydata %>% ggplot(aes( y = renda, x = escolaridade, weight = peso)) +
    geom_point()+
      theme_bw()+
      ggtitle("Renda | Escolaridade")+
      scale_y_continuous(name   = "Renda",
                         limits = c(0,255000))+
      scale_x_continuous(name = "Escolaridade")+
      labs(subtitle = "rela√ß√£o da renda em fun√ß√£o da escolaridade",
           caption = "1¬∫ trim./Pnad-cont√≠nua 2019")
```

O gr√°fico de dispers√£o acima representa as observa√ß√µes dada a escolaridade e a renda. Em geral, a vari√°vel a ser explicada (dependente) √© colocada no eixo vertical (y), no sentido de que est√° em fun√ß√£o de outras vari√°veis que podem ser explicativas. Embora fosse esperado uma correla√ß√£o entre escolaridade e renda, n√£o √© muito percept√≠vel essa informa√ß√£o no gr√°fico. Podemos observar em um grau moderado que h√° mais casos com renda elevada conforme aumenta a escolaridade. Vemos ainda que a vari√°vel escolaridade √© m√©trica discreta e reflete seu comportamento no gr√°fico, com pontos de observa√ß√£o aglomerados que se aproximam graficamente de linhas verticais.


# M√©dias ponderadas dos grupos de renda condicionados √† escolaridade
```{r fig.align="center", warning = FALSE, message = FALSE}
# nova base com a m√©dia ponderada(!) para cada grupo correspondente ao x anos de escolaridade
newdata1 <- mydata %>% group_by(escolaridade) %>% 
    summarise(media.renda = weighted.mean(renda))

newdata1 %>%
ggplot(aes( y = media.renda, x = escolaridade)) +
geom_point()+
    ggtitle("M√©dia(Renda | Escolaridade)")+
    scale_y_continuous(name = "Renda")+
    scale_x_continuous(name = "Escolaridade")+
    labs(subtitle = "M√©dia da renda em fun√ß√£o da escolaridade",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")

```

O gr√°fico de dispers√£o acima representa as m√©dias dos grupos de renda em fun√ß√£o da escolaridade. Podemos observar com maior clareza a rela√ß√£o positiva entre escolaridade e renda. Conforme cresce os anos de escolaridade, cresce a m√©dia da renda nos grupos.

```{r fig.align="center", warning = FALSE, message = FALSE}
newdata1 %>%
ggplot(aes( y = log(media.renda), x = escolaridade)) +
geom_point()+
    ggtitle("M√©dia( log(Renda) | Escolaridade )")+
    scale_y_continuous(name = "log da renda")+
    scale_x_continuous(name = "Escolaridade")+
    labs(subtitle = "M√©dia da renda logaritmizada em fun√ß√£o da escolaridade",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

O gr√°fico acima representa a m√©dia da renda logaritmizada em fun√ß√£o da escolaridade. Complicado, n√£o √©? Mas podemos observar aqui que a fun√ß√£o logaritmo da renda opera apenas como uma compress√£o das dist√¢ncias entre os casos. Vemos acima que a rela√ß√£o entre o log(renda) e escolaridade √© exatamente igual √† da renda, conforme o gr√°fico anterior. A diferen√ßa est√° no eixo vertical (y), em que podemos ver a maior proximidade entre as rendas, o que n√£o interfere na an√°lise de correla√ß√£o.

```{r fig.align="center", warning = FALSE, message = FALSE}
newdata2 <- mydata %>% group_by(idade) %>% 
    summarise(media.renda = weighted.mean(renda))

newdata2 %>%
ggplot(aes( y = media.renda, x = idade)) +
geom_point()+
    ggtitle("M√©dia(Renda | Idade)")+
    scale_y_continuous(name = "Renda")+
    scale_x_continuous(name = "Idade")+
    labs(subtitle = "M√©dia da renda em fun√ß√£o da idade",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

Agora com a idade podemos observar uma tend√™ncia relativamente diferente. Assim como com a escolaridade, h√° uma rela√ß√£o positiva entre renda e idade. No entanto, vemos tamb√©m que √© uma rela√ß√£o n√£o linear, pois o crescimento da renda permanece quase constante at√© 40 anos, quando come√ßa a crescer cada vez menos at√© se estabilizar. √â um crescimento parecido com o comportamento de uma curva logar√≠tmica.

# Experi√™ncia e renda
```{r fig.align="center", warning = FALSE, message = FALSE}
newdata3 <- mydata %>% group_by(exp) %>% 
    summarise(media.renda = mean(renda))

newdata3 %>%
ggplot(aes( y = media.renda, x = exp)) +
geom_point()+
    ggtitle("M√©dia( Renda | Experi√™ncia )")+
    scale_y_continuous(name = "Renda")+
    scale_x_continuous(name = "Experi√™ncia",
                       breaks = seq(0,64,4))+
    labs(subtitle = "rela√ß√£o da renda em fun√ß√£o da experi√™ncia",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

Agora com a experi√™ncia vemos outro comportamento na rela√ß√£o com a renda, mas ainda muito distante de ser um comportamento pr√≥ximo de uma aleatoriedade que indique a possibilidade de independ√™ncia. Vemos que h√° uma rela√ß√£o entre renda e experi√™ncia, que √© igual √† uma par√°bola: positiva at√© aprox. 12 anos, com estabilidade at√© aprox. 32 anos e queda deste ponto em diante. Se lembrarmos da an√°lise univariada da experi√™ncia, teremos que as faixas com menor experi√™ncia s√£o os mais jovens ou adultos com muitos anos de estudos. Conforme vimos no gr√°fico anterior, essa faixa et√°ria est√° em crescimento constante de renda at√© atingir um pico de estabiliza√ß√£o, o que vemos tamb√©m refletido na experi√™ncia (uma vez que est√° em fun√ß√£o da idade menos anos de estudo e menos a constante 6). A queda aqui representada para pode estar associada aos casos de pessoas mais idosas que n√£o acessaram a escola e, portanto, possuem menor anos de estudo.

Vamos ver com o log da renda como fica.

```{r fig.align="center", warning = FALSE, message = FALSE}
newdata3 %>%
ggplot(aes(y = log(media.renda), x = exp)) +
geom_point()+
    ggtitle("M√©dia( log(Renda) | Experi√™ncia )")+
    scale_y_continuous(name = "Renda")+
    scale_x_continuous(name = "Experi√™ncia",
                       breaks = seq(0,64,4))+
    labs(subtitle = "rela√ß√£o da renda em fun√ß√£o da experi√™ncia",
         caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")
```

Viu? N√£o mudou em nada na rela√ß√£o, conforme vimos com a escolaridade.

J√° que estamos come√ßando a falar de correla√ß√µes, vamos calcular a correla√ß√£o entre vari√°veis m√©tricas com o famoso para ver o quanto essas vari√°veis est√£o correlacionadas.

Para isso usamos o famoso ... Coeficiente de correla√ß√£o! :D
E no nosso caso ainda temos o peso (weights ou wtd)
```{r fig.align="center", warning = FALSE, message = FALSE}
# 1. Escolaridade e renda.
wtd.cor(mydata$renda, mydata$escolaridade)

# 2. Escolaridade e log da renda
wtd.cor(mydata$ln.renda, mydata$escolaridade)

# 3. experi√™ncia e renda
wtd.cor(mydata$renda, mydata$exp)

# 4. experi√™ncia e log da renda
wtd.cor(mydata$ln.renda, mydata$exp)
```

Agora estamos falando de correla√ß√£o. E opa! Temos uma correla√ß√£o diferente quando consideramos a renda logaritmizada!!! Viu? Mas vimos antes que a rela√ß√£o n√£o muda graficamente, n√£o √© mesmo? Ent√£o vamos abrir a caixa-preta para entender quando √© que o nosso avi√£o caiu.

A l√≥gica do c√°lculo de uma correla√ß√£o tem a ver com o tamanho da varia√ß√£o de nossa vari√°vel de interesse. Sabemos que ela sozinha possui uma varia√ß√£o que, para fins did√°ticos, chamemos de varia√ß√£o total. Quando condicionamos ela √† uma outra vari√°vel, podemos observar como se comporta a varia√ß√£o dela em fun√ß√£o da segunda vari√°vel. No exemplo da renda e escolaridade, fizemos a m√©dia da renda para cada grupo com determinado x anos de escolaridade, lembra? Se a varia√ß√£o da renda condicionada √† escolaridade √© menor do que a varia√ß√£o total da renda, ent√£o estamos explicando uma parte, n√£o √© mesmo?
Se em uma popula√ß√£o a renda possui uma varia√ß√£o X, e vimos que se separarmos a popula√ß√£o em grupos de escolaridade, esses grupos s√£o mais homog√™neos (possuem menos varia√ß√£o), ent√£o podemos dizer que parte da varia√ß√£o da renda se deve √† diferen√ßa de escolariza√ß√£o entre os grupos... e ent√£o estamos explicando a heterogeneidade da renda (varia√ß√£o)... e ent√£o podemos incluir mais outro condicionante e explicar a renda ainda mais... e ent√£o saberemos o que faz o rico ficar rico e o pobre ficar pobre... e ...

Eita pera l√°, muita calma ladr√£o...

Esqueceu que nosso problema √© o por qu√™ da correla√ß√£o da renda logaritmizada ser mais forte?

Pois ent√£o. Ainda que a rela√ß√£o seja a mesma, na pr√°tica, o logaritmo da renda √© algo diferente da renda original. Um outro tipo de informa√ß√£o. Nossa vari√°vel dependente n√£o est√° mais mensurada em `R$`, mas em algum tipo de unidade de medida estranha. E, obviamente, isso altera a interpreta√ß√£o dos coeficientes. Numa regress√£o com renda (n√£o modificada) como vari√°vel dependente, ler√≠amos: ‚Äúum ano mais de escolaridade est√° associado ao aumento de ùõΩ1 `R$` na renda‚Äù. Mas agora, temos algo que soa esquisito: ‚Äúum ano mais de escolaridade est√° associado ao aumento de ùõΩ1 no logaritmo da renda‚Äù.

Tendo a l√≥gica da correla√ß√£o, sabemos que estamos querendo explicar a heterogeneidade (varia√ß√£o) da renda. O conceito de heterogeneidade est√° associado a no√ß√£o de dist√¢ncia entre as partes de um todo. Do contr√°rio, falar√≠amos de homogeneidade. Se o logar√≠tmo √© uma fun√ß√£o que diminui a dist√¢ncia entre as observa√ß√µes, ou entre as partes do todo, logo teremos menos heterogeneidade, e assim um coeficiente de correla√ß√£o mais forte. Pode ser que esteja errado e eu esteja exagerando, mas o erro e o exagero fazem parte da profiss√£o (Weber, 1920).

# 4. Voltando ao modelo de Mincer

Os resultados sobre a vari√°vel experi√™ncia mostram que a rela√ß√£o com a renda √© uma esp√©cie de par√°bola, n√£o √©? Uma curva que sobe, atingindo um m√°ximo em certo ponto, e depois desce. Bem, essa √© a raz√£o pela qual na equa√ß√£o de Mincer experi√™ncia est√° aparecendo duas vezes: uma sem quadrado e outra com quadrado. Pode ser que voc√™s n√£o se lembrem muito da Matem√°tica de Ensino M√©dio; mas ‚Äúcoisas ao quadrado‚Äù s√£o par√°bolas. E par√°bolas possuem um formato padr√£o de equa√ß√£o:

ùë¶=ùëéùë•^2 +ùëè*ùë•+ùëê

Em princ√≠pio, apenas ùë¶=ùë•2 j√° nos fornece uma par√°bola. experimente, por exemplo, substituir ùë• por -3, -2, -1, 0, 1, 2, 3 ent√£o calcular os respectivos valores de ùë¶. S√©rio! Fa√ßa isso e plote o gr√°fico (pode ser at√© no Excel). Voc√™ vai ver a par√°bola se formar.

```{r fig.align="center", warning = FALSE, message = FALSE}
x <- seq(from = -5, to = 5, by = 1)

plot(x = x, y = -x^2,type = "b")
```

O que vamos ter √© uma par√°bola com ‚Äúa boca virada pra baixo‚Äù, que passa pelo ponto (0,0), a ‚Äúorigem‚Äù das coordenadas cartesianas. O que a equa√ß√£o acima, ùë¶=ùëéùë•2+ùëèùë•+ùëê, traz de diferente? Ela fornece uma express√£o geral para toda e qualquer par√°bola: virada pra cima ou pra baixo; com a concavidade mais aberta ou mais fechada; centrada em qualquer lugar do gr√°fico; com as ‚Äúpernas‚Äù da curva mais ou menos sim√©tricas... etc. Essa express√£o mais completa, tamb√©m chamada de equa√ß√£o de segundo grau (porque tem uma vari√°vel elevada a dois!), n√£o √© s√≥ formada pelo termo quadr√°tico: ela contem tamb√©m um ùë• que n√£o est√° elevado a 2 (o chamamos de termo linear) e cont√©m ainda um termo constante,ùëê, que n√£o est√° ligado ao ùë•.

Observe a equa√ß√£o de Mincer novamente. Ela cont√©m: ùõΩ0 + ùõΩ2ùëã+ùõΩ3ùëã^2. 

Ora, esses s√£o exatamente os mesmos termos da equa√ß√£o de segundo grau. A par√°bola (aproximada) formada pela experi√™ncia incorre exatamente no caso citado no par√°grafo anterior: ela √© uma par√°bola mais complexa, que, para ser desenhada, precisa do termo quadr√°tico, do termo linear e de uma constante. Por padr√£o, a constante j√° est√° sempre na regress√£o: √© o intercepto, o termo que n√£o est√° ligado a nenhuma vari√°vel. O que precisaremos fazer ent√£o √© incluir um termo quadr√°tico e um termo linear, quando formos estimar a regress√£o. Isso permite que o R tente ajustar a curva com mais flexibilidade. Se ele encontrar uma ‚Äúpar√°bola meio torta‚Äù, ele vai conseguir estimar, ajustando os valores dos coeficientes ùõΩ2 e ùõΩ3.

Se o R descobrir que o termo linear n√£o √© necess√°rio e que apenas ùê∏ùë•ùëùùëíùëüùëñ√™ùëõùëêùëñùëé2 j√° √© suficiente, ent√£o o valor estimado para o coeficiente do termo linear ser√° igual a zero (isto √©: teremos ùõΩ2=0). Assim, ùõΩ2ùëãùëñ iria resultar em 0√óùëãùëñ=0, cancelando o termo. Se, ao contr√°rio, o R descobrir que n√£o se trata de uma par√°bola, mas sim de uma reta, quem vai ser igual a zero √© o ùõΩ3. E ter√≠amos ùõΩ3ùëãùëñ2=0√óùëãùëñ2=0. Assim voltar√≠amos, na pr√°tica, a um comportamento linear convencional da rela√ß√£o entre experi√™ncia e renda. O ajuste, no final das contas, √© emp√≠rico. Por isso, √© necess√°rio incluir tanto o termo linear quanto o quadr√°tico, quando se suspeita que a rela√ß√£o entre a vari√°vel independente e a dependente forma um desenho aproximado de uma par√°bola.

O que precisamos saber:
1. Rela√ß√µes entre vari√°veis que apresentaram um ‚Äúsobe e desce‚Äù nos diagramas de dispers√£o s√£o modeladas com par√°bolas
2. Par√°bolas s√£o obtidas por meio da inclus√£o de um termo quadr√°tico como vari√°vel independente numa regress√£o ‚Äì com manuten√ß√£o do termo linear (pois a√≠ teremos flexibilidade para ajustar diversos desenhos de par√°bolas).
3. Em suma: a par√°bola √© obtida por meio de uma transforma√ß√£o no ùë• (a vari√°vel independente de interesse), n√£o no ùë¶ (a vari√°vel dependente): √© o ùë• que √© elevado ao quadrado!

Uma coisa importante se altera: a leitura e a interpreta√ß√£o dos coeficientes. As vari√°veis que apenas possuem termo linear s√£o muito simples de ler, porque s√£o retas, fun√ß√µes de primeiro grau. Nesse caso, o coeficiente de regress√£o ligado √† vari√°vel que √© apenas linear expressa a inclina√ß√£o da reta. Considere, por exemplo a regress√£o m√∫ltipla abaixo:

ùë¶ùëñ=ùõΩ0+ùõΩ1ùë•ùëñ1+ùõΩ2ùë•ùëñ2+ùúñùëñ

Mas quando uma mesma vari√°vel possui um termo quadr√°tico e um termo linear, a interpreta√ß√£o passa a n√£o ser mais essa. Tomem o exemplo abaixo:

ùë¶ùëñ=ùõΩ0+ùõΩ1ùë•ùëñ1+ùõΩ2ùë•ùëñ12+ùúñùëñ

Aqui temos duas vezes a mesma vari√°vel, ùë•ùëñ1: na vers√£o linear e na vers√£o quadr√°tica. Quando ùë•ùëñ1 aumenta, esse aumento √© simult√¢neo nos dois termos ‚Äì pois se trata, como j√° dito, da mesma vari√°vel. Isso significa que ùõΩ1ùë•ùëñ1+ùõΩ2ùë•ùëñ12 deve ser encarado como uma unidade indissoci√°vel. N√£o √© poss√≠vel interpretar ùõΩ1 separadamente de ùõΩ2. Al√©m disso, cabe destacar que uma par√°bola n√£o possui a mesma inclina√ß√£o em todas as suas partes. Por essa raz√£o os coeficientes da express√£o ùõΩ1ùë•ùëñ1+ùõΩ2ùë•ùëñ12 n√£o podem ser lidos como indicando apenas inclina√ß√£o.

Isso pode parecer complicado √† primeira vista, mas tem uma interpreta√ß√£o bastante intuitiva: nas primeiras quantidades ùë• t√™m um grande efeito sobre ùë¶; mas quantidades adicionais de ùë• v√£o tendo cada vez menos efeito, at√© que ent√£o a dire√ß√£o se inverte. Pense em doses de um rem√©dio, por exemplo: cada gota adicional de analg√©sico tem um efeito positivo sobre seu bem-estar (reduzindo uma dor de cabe√ßa, por exemplo), at√© chega um ponto em que voc√™ come√ßa a se intoxicar e o efeito passa a ser o oposto. Sabe aquela frase da sua av√≥: ‚Äútudo o que √© demais faz mal‚Äù? Ent√£o... era, na realidade, uma par√°bola!

No caso da experi√™ncia no mercado de trabalho, o que estaria ocorrendo? A Teoria do Capital Humano sustenta que o capital humano, assim como o f√≠sico, se deprecia com o tempo: esquecemos conhecimentos, nos tornamos obsoletos, nossa sa√∫de e nossa disposi√ß√£o para produzir minguam... Assim, pessoas com muitos anos de experi√™ncia passam a experimentar quedas salariais.

Quando as vari√°veis tem efeito em forma de par√°bola, √© muito mais f√°cil avaliar o que est√° acontecendo de maneira gr√°fica. Produzimos um conjunto de valores preditos e ent√£o plotamos para tentar compreender o resultado. Existem, na realidade, modos um pouco mais sofisticados para entender o que est√° acontecendo e estudar esses efeitos n√£o lineares. Mas isso √© mat√©ria para Lego II.

As par√°bolas s√£o um caso particular da chamada Regress√£o Polinomial: na verdade, podemos ajustar quase qualquer desenho de curva apenas com a inclus√£o de polin√¥mios de grau mais elevado (i.e. termos que est√£o elevados a pot√™ncias maiores). E vejam s√≥... no final, a regress√£o chamada ‚Äúlinear‚Äù s√£o √© apenas linear. Com alguns ajustes e modifica√ß√µes, conseguimos desenhar par√°bolas e diversas outras curvas.

Mas vamos continuar ao trabalho seguindo os passos para aplicar o modelo de Mincer.

# 5. It's time to regression!
```{r}
# experi√™ncia ao quadrado (uma par√°bola!)
mydata$exp2 <- mydata$exp^2

fit <- lm(renda ~ exp, data = mydata, weights = peso)
summary(fit)

fit2 <- lm(renda ~ exp + exp2, data = mydata, weights = peso)
summary(fit2)
```

No primeiro modelo de regress√£o estimado estamos considerando o efeito da experi√™ncia na renda com um termo linear, o que n√£o √© adequado, pois sabemos que o comportamento dessa rela√ß√£o √© mais parecido com o de uma par√°bola e uma fun√ß√£o linear n√£o pode defini-lo. Estamos decompondo a varia√ß√£o de Y (renda) em dois termos, e a informa√ß√£o adicionada da experi√™ncia quadr√°tica reduz a explica√ß√£o da experi√™ncia linear e acrescenta uma informa√ß√£o sobre o comportamento da rela√ß√£o. Esse acrescimo de informa√ß√£o ou explica√ß√£o do segundo modelo pode ser observado pela estat√≠stica R2. Para o primeiro modelo, estamos explicando muito pouco da varia√ß√£o da renda (0.0001), enquanto que no segundo aumentamos nossa explica√ß√£o significativamente (0.0164).

O erro de reduzir uma rela√ß√£o n√£o linear em uma fun√ß√£o linear pode ser observado no gr√°fico seguinte:

# Observando o erro da fun√ß√£o linear em uma par√°bola
```{r fig.align="center", warning = FALSE, message = FALSE}
newdata3 %>%
     ggplot(aes( y = media.renda, x = exp)) +
     geom_point()+
     ggtitle("M√©dia( Renda | experi√™ncia )")+
     scale_y_continuous(name = "Renda")+
     scale_x_continuous(name = "experi√™ncia",
                        breaks = seq(0,64,4))+
     labs(subtitle = "Observando o erro da regress√£o linear",
          caption = "Fonte: 1¬∫ trim./Pnad-cont√≠nua 2019")+
     geom_smooth(aes(), method = lm, se = T, fullrange = T)
```

# Renda e educa√ß√£o
```{r}
fit3 <- lm(ln.renda ~ escolaridade, data = mydata, weights = peso)
summary(fit3)

fit4 <- lm(ln.renda ~ escolaridade + exp + exp2, data = mydata, weights = peso)
summary(fit4)
```

Analisando a rela√ß√£o entre renda, escolaridade e a experi√™ncia, podemos observar a mesma diferen√ßa discutida anteriormente. No primeiro modelo consideramos apenas a escolaridade como fator linear explicativo da renda, onde observamos que a cada uma unidade de escolaridade, aumentamos 0.1 no logar√≠tmo da renda (o que √© dif√≠cil de interpretar). Neste modelo temos o R2 0.22, o que representa uma explica√ß√£o significativa. 
O segundo modelo acrescenta as vari√°veis experi√™ncia e experi√™ncia ao quadrado. Neste observamos que houve um aumento do coeficiente em rela√ß√£o √†s tr√™s vari√°veis analisadas s√≥zinhas, anteriormente. Al√©m disso, nossa explica√ß√£o sobre a varia√ß√£o da renda aumentou para R2 0.286. Essa mudan√ßa se deve √† intera√ß√£o estat√≠stica entre as vari√°veis. Neste caso, vemos que experi√™ncia e escolaridade est√£o mutuamente relacionadas, uma fortalecendo o efeito da outra sobre a renda; o que faz sentido quando olhamos para a formula da experi√™ncia por Mincer, que tem a experi√™ncia em fun√ß√£o da escolaridade.

```{r fig.align="center", warning = FALSE, message = FALSE}
newdata <- data.frame(idade = 11+6+c(0:50),
                      escolaridade = rep(11,51),
                      exp = c(0:50),
                      exp2 = c(0:50)^2 )

preditos <- predict(fit4, newdata = newdata)

plot(y = preditos, x = c(0:50),
     main = "Predi√ß√µes com a regress√£o",
     ylab = "Valores preditos pela regress√£o",
     xlab = "idades 0-50 anos")

```

O gr√°fico acima representa os valores preditos da regress√£o para indiv√≠duos com idade de 0-50 anos. Observamos que entre 45 e 50 anos o logar√≠tmo da renda come√ßa a cair, o que sugere que nessa idade muda o efeito na renda, tendendo a cair.

# An√°lise gr√°fica dos res√≠duos da regress√£o
```{r fig.align="center", warning = FALSE, message = FALSE}
plt1 <- ggplot()+
    geom_point(aes(x = fitted(fit4), y = resid(fit4)))+
    theme_classic()+
    ggtitle("Distribui√ß√£o dos res√≠duos da regress√£o: valores preditos")+
    scale_x_continuous(name = "Valores preditos",
                        limits =  c(4, 9))+
    scale_y_continuous(name = "Res√≠duos",
                        limits = c(-5,5))+
    labs(subtitle = "Analisando a homocedasticidade",
         caption = "")+
    geom_hline(yintercept = 0, color = "blue")

ggMarginal(plt1,type="histogram", groupFill = F,alpha = 0.5, 
           margins = "y")


```

# Res√≠duos vs escolaridade
```{r fig.align="center", warning = FALSE, message = FALSE}
plt2 <- mydata %>% ggplot()+
    geom_point(aes(x = escolaridade, y = resid(fit4)))+
    theme_classic()+
    ggtitle("Distribui√ß√£o dos res√≠duos da regress√£o: escolaridade")+
    scale_x_continuous(name = "Escolaridade"
                        #limits =  c(4, 9)
                        )+
    scale_y_continuous(name = "Res√≠duos",
                        limits = c(-5,5))+
   labs(subtitle = "Analisando a homocedasticidade",
         caption = "")+
    geom_hline(yintercept = 0, color = "blue")

ggMarginal(plt2,type="histogram", groupFill = F,alpha = 0.5, 
           margins = "y")
```

Os gr√°ficos acima representam a dispers√£o dos valores preditos para as idades 0-50 (plt1) e para os anos de escolaridade (plt2), ambos em rela√ß√£o aos res√≠duos. Portanto, temos a reta estimada pela regress√£o, que √© tra√ßada na menor dist√¢ncia entre os res√≠duos (linha azul do marco 0 no eixo vertical), como uma aproxima√ß√£o da m√©dia da renda (Y) condicionada √†s vari√°veis (X). Podemos observar que os res√≠duos se concentram homogeneamente ao redor da reta de regress√£o estimada, o que respeita o pressuposto da homocedasticidade. Em outras palavras, a varia√ß√£o em torno da reta de regress√£o √© mais pr√≥xima de uma constante, n√£o muda muito. Vemos tamb√©m que os res√≠duos est√£o normalmente distribu√≠dos. No histograma na margem √† direita, podemos observar que a distribui√ß√£o dos res√≠duos √© muito pr√≥xima de uma distribui√ß√£o em sino como a da curva normal.

# 6. Aplicando nas PNAD's cont√≠nuas de 2012-2020

```{r fig.align="center", warning = FALSE, message = FALSE}
# ano <- c(2019)
# for(i in 1:length(ano)) {
#     print(i)
#     ano_i <- ano[i]
#     pnad_i <- get_pnadc(year = ano_i, quarter = 1,
#                               design = F, labels = T)
#      export(pnad_i, paste0(wd, ano_i , "/pnadc_", ano_i, "-1q.fst") )
#      export(pnad_i, paste0(wd, ano_i , "/pnadc_", ano_i, "-1q.csv") )
#                }

ano = c(2012:2019)

reg <- data.frame(intercept    = rep(NA,8),
                  escolaridade = rep(NA,8),
                  exp          = rep(NA,8),
                  exp2         = rep(NA,8) )

for(i in 1:length(ano)) {
			print(i)   # --- para imprimir no console cada itera√ß√£o
			ano_i       <- ano[i] # pega o 'i' ano e guarda no objeto ano_i
			arquivo_i <- paste0(ano_i, "/pnadc_", ano_i, "-1q.fst") # Caminho para o arquivo_i do ano_i
			
			data <- import( paste0(wd, arquivo_i) )%>% # abre o arquivo_i do ano_i
    
			  select(V2009, VD3005,VD4016,V1027) %>% # seleciona essas var
    
			  rename(., idade        = V2009,        # renomeie as var
                  escolaridade = VD3005,
                  renda        = VD4016,
                  peso         = V1027) %>% 
        filter(renda > 0, idade %in% 18:65) %>% # filtra idade
          
			  mutate(., escolaridade = as.numeric(escolaridade), # Fa√ßa modifica√ß√µes
                    ln.renda   = log(renda),
                    exp        = idade - escolaridade - 6, # exp de Mincer
                    exp2       = exp^2,
                    exp        = ifelse(exp < 0, 0, exp) ) 
			
			fit <- lm(ln.renda ~ escolaridade + exp + exp2, data = data, weights = peso) # Regress√£o modelo de Mincer
			
			reg[i,] <- fit$coefficients # vai na lista da regress√£o e pega os coef
      
			rm(data,fit) # Remova o objeto
      gc()
    }

save(reg, file = paste0(wd, "reg-mincer-pnad12-19.RData" ) )

reg$ano <- ano

reg %>% ggplot(aes(x = ano, y = escolaridade))+
  theme_classic()+
  geom_line(lwd = 1)+
  labs( title = "Retornos em educa√ß√£o 2012-2019",
        subtitle = "Modelo de Mincer",
        caption = "Fonte: PNADc/IBGE 2012-2019.")+
  scale_x_continuous(name = "Anos",
                     breaks =  (seq(2012,2019,1)) )+
 scale_y_continuous(name = "Coecifiente de educa√ß√£o",
                    limits =  c(0,0.15))

```

O gr√°fico acima representa a varia√ß√£o do coeficiente angular da educa√ß√£o estimado pela equa√ß√£o de Mincer entre os anos 2012 e 2019 da PNAD cont√≠nua. O coeficiente indica quanto da renda logaritmizada (y) varia em uma unidade de aumento em educa√ß√£o (x). Como estamos trabalhando com a renda logaritmizada, a varia√ß√£o em renda √© dif√≠cil de ser interpretada. Cada valor representa o logar√≠tmo natural da renda (base euler = 2.7). Portanto, 2.7^0.01 representa o aumento em 1 real na renda. 
Embora com pouca varia√ß√£o, podemos observar que o retorno em educa√ß√£o cai entre 2012 e 2014, quando come√ßa a aumentar at√© 2019. Isso indica que a partir de 2014 houve um crescimento constante do retorno em educa√ß√£o, embora pouco expressivo i.e. com pouca varia√ß√£o.
Com uma manipula√ß√£o do eixo vertical (y), podemos observar com maior detalhe a tend√™ncia.

```{r fig.align="center", warning = FALSE, message = FALSE}
reg %>% ggplot(aes(x = ano, y = escolaridade))+
  theme_classic()+
  geom_line(lwd = 1)+
  labs( title = "Retornos em educa√ß√£o 2012-2019",
        subtitle = "Modelo de Mincer",
        caption = "Fonte: PNADc/IBGE 2012-2019.")+
  scale_x_continuous(name = "Anos",
                     breaks =  (seq(2012,2019,1)) )+
 scale_y_continuous(name = "Coecifiente de educa√ß√£o",
                    limits =  c(0.10,0.15))+
  geom_vline(xintercept = 2014, lty = 2, color = "red")
```

